<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index</title>
</head>

<body>
    <h3>Ciracino88's ServerğŸ€</h3>
    <hr>
    <div id="messages"></div>

    <form id="form">
        <input id="input" autocomplete="off" placeholder="ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš©">
        <button>ë“±ë¡</button>
    </form>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

        const supabase = createClient(
            'https://ciszaukmnglepvqpulya.supabase.co',
            "sb_publishable_s_BMgLmH4w_8boe7SWq59Q_p9fLDEU-"
        )

        const socket = io();

        const messages = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");

        const currentUserID = null;

        async function signInAnonymously() {
            try {
                // í˜„ì¬ ì„¸ì…˜ í™•ì¸ : ì´ë¯¸ ë¡œê·¸ì¸ ì¤‘ì¸ê°€?
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();

                if (session) {
                    showLoginMessage(`${session.user.id}`);
                    currentUserID = session.user.id;
                    await loadMessages();
                    return;
                }

                // ìµëª… ë¡œê·¸ì¸ ì‹œë„
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) {
                    console.log("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨: ", error.message);
                    return;
                }

                // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ, ë©”ì‹œì§€ í‘œì‹œ
                showLoginMessage(`${session.user.id}`);
                currentUserID = session.user.id;
                await loadMessages();
            } catch (err) {
                showLoginMessage("ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ")
            }
        }

        // í™”ë©´ì— ë©”ì‹œì§€ í‘œì‹œ
        function showLoginMessage(text) {
            const log = document.createElement("p");
            log.textContent = text;
            messages.appendChild(log);
            messages.scrollTop = messages.scrollHeight;
        }

        // ê³¼ê±° ë©”ì‹œì§€ ë‚´ì—­ ë¡œë“œ
        async function loadMessages() {
            try {
                // ì„œë²„ì— ì œê³µí•  ì—”ë“œí¬ì¸íŠ¸
                const res = await fetch("/past-message");
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                await showLoginMessage(`${data.length}ê°œì˜ ë©”ì‹œì§€ ë¡œë“œ`);
                data.forEach(msg => addMessage(msg.content, msg.username || 'ìµëª…', false));
            } catch (e) {
                console.log("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨", e);
            }
        }

        function addMessage(content, username = "ìµëª…", isSent = false) {
            const item = document.createElement("div");

            item.className = `message ${isSent ? "sent" : "received"}`;
            item.innerHTML = `<strong>${username}</strong>: ${content}`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            if (input.value) {
                // ìœ ì € ë„¤ì„ ì„ì˜ë¡œ ë¶€ì—¬ (user)
                const msg = { content: input.value, username: "user", currentUserID: currentUserID };
                socket.emit('chat', msg);
                addMessage(msg.content, msg.username, true);
                input.value = '';
            }
        });

        socket.on('chat', (msg) => {
            addMessage(msg.content, msg.username || 'ìµëª…', false);
        });

        socket.on('connect', () => {
            console.log("socket connected");
            loadMessages();
        });

        signInAnonymously();
    </script>
</body>

</html>