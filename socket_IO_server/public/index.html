<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index</title>
</head>
<body>
    <h3>Ciracino88's ServerğŸ€</h3>
    <hr>
    <div id="messages"></div>

    <form id="form">
        <input id="input" autocomplete="off" placeholder="ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš©">
        <button>ë“±ë¡</button>
    </form>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        const messages = document.getElementById("messages");
        const form = document.getElementById("form");
        const input = document.getElementById("input");

        // ê³¼ê±° ë©”ì‹œì§€ ë‚´ì—­ ë¡œë“œ
        async function loadMessages() {
            try {
                // ì„œë²„ì— ì œê³µí•  ì—”ë“œí¬ì¸íŠ¸
                const res = await fetch("/past-message");
                const data = await res.json();
                data.forEach(msg => addMessage(msg.content, msg.username || 'ìµëª…'));
            } catch (e) {
                console.log("ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨", e);
            }
        }

        function addMessage(content, username = "ìµëª…") {
            const item = document.createElement("div");

            item.className = 'messages_item';
            item.textContent = `${username}: ${content}`;
            messages.append(item);
            messages.scrollTop = messages.scrollHeight;
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            if (input.value) {
                // ìœ ì € ë„¤ì„ ì„ì˜ë¡œ ë¶€ì—¬ (user)
                const msg = { content: input.value, username: "user" };
                socket.emit('chat', msg);
                addMessage(input.value, 'ciracino88');
                input.value = '';
            }
        });

        socket.on('chat', (msg) => {
            addMessage(msg.content, msg.username || 'ìµëª…');
        });

        socket.on('connect', () => {
            loadMessages();
        });
    </script>
</body>
</html>